<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="pragma" content="no -cache">
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
<meta http-equiv="expires" content="0">
<title>交易统计-法奈昇大数据平台</title>
<meta name="keywords" content="法奈昇大数据平台">
<meta name="description" content="法奈昇大数据平台">
<link rel="shortcut icon" href="favicon.ico">
<link href="js/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="js/bootstrap/css/font-awesome.css" rel="stylesheet">
<link href="css/plugins/bootstrap-table/bootstrap-table.min.css"
	rel="stylesheet">
<link
	href="js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css"
	rel="stylesheet">
<link href="css/plugins/bootstrap/fileinput.css" rel="stylesheet">
<link href="css/style.min.css" rel="stylesheet">
<link href="css/custom.css" rel="stylesheet">
</head>

<body class="gray-bg">
	<div class="panel-body animated fadeInRight">
		<div class="panel panel-default">
			<form id="formSearch" class="form-horizontal">
				<div class="form-group" style="margin-top: 15px">
					<div class="row col-sm-9">
						<!-- <div class="col-sm-4">
                        <label class="control-label" for="txt_search_id">订单号:</label>
                        <input type="text" class="form-control" id="txt_search_id" name="orderNo" placeholder="请输入需要搜索的订单号">
                    </div> -->
						<div class="col-sm-6">
							<label class="control-label" for="txt_search_name">商户号:</label> <input
								type="text" class="form-control" id="txt_search_name"
								name="merId" placeholder="请输入需要搜索的结算商户号" />
						</div>
						<div class="col-sm-6">
							<label class="control-label" for="txt_search_price">商户名:</label>
							<input type="text" class="form-control" id="merName"
								name="merName" placeholder="请输入需要搜索的商户名" />
						</div>
						<div class="col-sm-12 query-time">
							<label class="control-label" for="txt_search_price">支付日期:</label>
							<input type="text" value="" class="form-control"
								id="datetimepicker1" name="startTime"> - <input
								type="text" value="" class="form-control" id="datetimepicker2"
								name="endTime">
						</div>
						<!-- <div class="col-sm-4">
                        <label class="control-label" for="txt_search_price">交易金额:</label>
                        <input type="text" class="form-control" id="txt_search_price" name="amt" placeholder="请输入需要搜索的金额"/>
                    </div>
                    <div class="col-sm-8 query-time">
                        <label class="control-label" for="txt_search_price">发送日期:</label>
                        <input type="text" value="" class="form-control" id="datetimepicker1" name="startSendTime"> -
                        <input type="text" value="" class="form-control" id="datetimepicker2" name="endSendTime">
                    </div> -->
					</div>
					<div style="display: none;">
									 <input type="text" class="form-control" id=innerCode name="innerCode"
									required="required">
									 <input type="text" class="form-control" id=code name="code"
									required="required">
									 <input type="text" class="form-control" id=date name="date"
									required="required">
							</div>
					<div class="col-sm-3" style="text-align: right;">
						<button type="button" id="btn_query" class="btn btn-primary"
							onclick="javascript:queryEvent();">
							<span class="glyphicon glyphicon-search"></span>查询
						</button>
						<button type="button" id="btn_reset" class="btn btn-default"
							onclick="javascript:resetEvent();">
							<span class="glyphicon glyphicon-refresh"></span>重置
						</button>
						<button type="button" id="btn_export" class="btn btn-info"
							onclick="javascript:exportEvent();">
							<span class="glyphicon glyphicon-export"></span>导出
						</button>
						<!-- <button type="button" id="btn_import" class="btn btn-info" onclick="javascript:importEvent();"><span class="glyphicon glyphicon-import"></span>导入</button> -->
					</div>
				</div>
			</form>
			<div class="ibox float-e-margins">
				<div class="ibox-content">
					<div class="row row-lg">
						<div class="col-sm-12">
							<table id="table"></table>
						</div>
					</div>
				</div>
			</div>
			<!-- end -->
		</div>
	</div>
	<!-- detailsModel详情 start -->
    <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModelLabel" data-backdrop="static" data-keyboard="false">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	                <h4 class="modal-title" id="editModalLabel">详情</h4>
	            </div>
	            <div class="ibox float-e-margins">
				<div class="ibox-content">
					<div class="row row-lg">
						<div class="col-sm-12">
							<table id="detailsTable"></table>
						</div>
					</div>
				</div>
			</div>
	        </div>
	    </div>
	</div>    

	<script src="https://cdn.staticfile.org/jquery/2.1.4/jquery.min.js"></script>
	<script
		src="https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<!-- <script src="js/content.min.js"></script> -->
	<script src="js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
	<script src="js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
	<script src="js/plugins/bootstrap-table/bootstrap-table-export.js"></script>
	<script src="js/plugins/bootstrap-table/tableExport.js"></script>
	<script src="js/plugins/bootstrap-table/bootstrap-table-editable.js"></script>
	<script src="js/plugins/bootstrap-table/bootstrap-editable.js"></script>
	<script src="js/plugins/bootstrap-table/bootstrap-table-zh-CN.min.js"></script>
	<script
		src="js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script
		src="js/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<script src="js/plugins/bootstrap/fileinput.js"></script>
	<script src="js/plugins/bootstrap/zh.js"></script>
	<script type="text/javascript" src="js/fnsco/common.js"></script>

</body>
<script type="text/javascript">
	$('#table').bootstrapTable({
		search : false, //是否启动搜索栏
		sidePagination : 'server',
		url : PROJECT_NAME + '/web/tradeStatistics/query',
		showRefresh : false,//是否显示刷新按钮
		showPaginationSwitch : false,//是否显示 数据条数选择框(分页是否显示)
		toolbar : '#toolbar', //工具按钮用哪个容器
		striped : true, //是否显示行间隔色
		cache : false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
		pagination : true, //是否显示分页（*）
		sortable : true, //是否启用排序
		sortOrder : "asc", //排序方式
		pageNumber : 1, //初始化加载第一页，默认第一页
		pageSize : 15, //每页的记录行数（*）
		pageList : [ 15, 20, 50, 100 ], //可供选择的每页的行数（*）
		queryParams : queryParams,
		responseHandler : responseHandler,//处理服务器返回数据
		columns : [ {
			field : 'id',
			title : '操作',
			align : 'center',
			width : 100,
			align : 'center',
			formatter : operateFormatter
		}, {
			field : 'innerCode',
			title : '内部商户号',
			align : 'center'
		}, {
			field : 'merId',
			title : '结算商户号',
			align : 'center'
		}, {
			field : 'merName',
			title : '商户名',
			align : 'center'
		}, {
			field : 'terminalCode',
			title : '终端号',
			align : 'center'
		}, {
			field : 'tradeDate',
			title : '支付时间',
			align : 'center',
			formatter:formatDate
		}, {
			field : 'orderNum',
			title : '交易笔数',
			align : 'center'
		}, {
			field : 'turnover',
			title : '交易金额(元)',
			formatter : formatAmt,
			align : 'right'
		} ]
	});
	// 操作格式化
	function operateFormatter(value, row, index) {
		return [
				"<a class='redact' href='javascript:querySingle(" + value +","+1+row.innerCode+","+row.tradeDate +","+row.terminalCode+ ");' title='详情'>",
				"<i class='glyphicon glyphicon-file'></i>", "</a>  " ].join("");
	}
	//金额格式化
	function formatAmt(value, row, index) {
		if (value) {
			var num = Number(value);
			var res = returnFloat(num / 100);
			return res;
		}
		return '--';
	}
	function returnFloat(value) {
		var value = Math.round(parseFloat(value) * 100) / 100;
		var xsd = value.toString().split(".");
		if (xsd.length == 1) {
			value = value.toString() + ".00";
			return value;
		}
		if (xsd.length > 1) {
			if (xsd[1].length < 2) {
				value = value.toString() + "0";
			}
			return value;
		}
	}
	//时间格式化
	function formatDate(value, row, index) {
		var r=value.replace(/^(\d{4})(\d{2})(\d{2})$/, "$1-$2-$3");
		return r;
	}
	function formatTime(value, row, index) {
		return formateTimeUtil(value);
	}
	//详情按钮事件
	function querySingle(id,innerCode1,date,code) {
		var innerCode = innerCode1.toString().substr(1);
		$('#innerCode').val(innerCode);
		$('#code').val(code);
		$('#date').val(date);
		$('#detailsModal').modal();
		querydetailsModal();
		$('#detailsTable').bootstrapTable({
			search : false, //是否启动搜索栏
			sidePagination : 'server',
			url : PROJECT_NAME + '/web/tradeStatistics/queryTrade',
			showRefresh : false,//是否显示刷新按钮
			showPaginationSwitch : false,//是否显示 数据条数选择框(分页是否显示)
			toolbar : '#toolbar', //工具按钮用哪个容器
			striped : true, //是否显示行间隔色
			cache : false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			pagination : true, //是否显示分页（*）
			sortable : true, //是否启用排序
			sortOrder : "asc", //排序方式
			pageNumber : 1, //初始化加载第一页，默认第一页
			pageSize : 100, //每页的记录行数（*）
			pageList : [ 15, 20, 50, 100 ], //可供选择的每页的行数（*）
			queryParams : queryDetailsParams,
			responseHandler : responseHandler,//处理服务器返回数据
			columns : [ {
				field: 'orderNo',
	            title: '订单号',
				align : 'center'
			}, {
				field: 'timeStamp',
	            title: '支付时间',
				align : 'center',
	            formatter:formatTime
			}, {
				field: 'certifyId',
	            title: '卡号',
				align : 'center'
			},{
				field: 'amt',
	            title: '交易金额(元)',
	            formatter:formatAmt,
				align : 'right'
			}, {
				field: 'status',
	            title: '状态',
	            formatter:formatStatus
			} ]
		});
	}
	//组装请求参数
	function queryDetailsParams(params) {
		var param = {
			"currentPageNum" : this.pageNumber,
			"pageSize" : this.pageSize,
			"innerCode" : $.trim($('#innerCode').val()),
			"terminalCode" : $.trim($('#code').val()),
			"tradeDate" : $.trim($('#date').val()),
		}
		return param;
	}
	//条件查询按钮事件
	function queryEvent() {
		$('#table').bootstrapTable('refresh');
	}
	//条件查询按钮事件
	function querydetailsModal() {
		$('#detailsTable').bootstrapTable('refresh');
	}
	//重置按钮事件
	function resetEvent() {
		$('#formSearch')[0].reset();
	}
	//导出按钮事件
	function exportEvent() {
		//拼接参数
		var merId = $.trim($('#txt_search_name').val());
		var merName = $.trim($('#merName').val());
		var startTime = $('#datetimepicker1').val();
		var endTime = $('#datetimepicker2').val();
		var url = PROJECT_NAME + '/web/tradeStatistics/export' +  '?merId=' + merId 
				+ '&merName=' + merName  
				+ '&startTime=' + startTime 
				+ '&endTime=' + endTime;
		window.open(url, 'Excel导出');
	}
	window.operateEvents = {
		'click .redact' : function(e, value, row, index) {
			alert('You click like action, row: ' + JSON.stringify(row));
		},
		'click .remove' : function(e, value, row, index) {
			$table.bootstrapTable('remove', {
				field : 'id',
				values : [ row.id ]
			});
		}
	};

	//组装请求参数
	function queryParams(params) {
		var param = {
			currentPageNum : this.pageNumber,
			pageSize : this.pageSize,
			merId : $.trim($('#txt_search_name').val()),
			merName : $.trim($('#merName').val()),
			startTime : $('#datetimepicker1').val(),
			endTime : $('#datetimepicker2').val()
		}
		return param;
	}
	//处理后台返回数据
	function responseHandler(res) {
		unloginHandler(res);
		if (res) {
			return {
				"rows" : res.list,
				"total" : res.total
			};
		} else {
			return {
				"rows" : [],
				"total" : 0
			};
		}
	}
	//状态格式化
	  function formatStatus(value, row, index){
		  if(!value){
		    	return '-';
		    }
		  else if(value == 0){
			  return '非正常交易';
		  }
		  else if(value == 1){
			  return '正常交易';
		  }
	  } 
	$('#datetimepicker1').datetimepicker({
		format : 'yyyy-mm-dd',
		autoclose : true,
		todayBtn : true,
		todayHighlight : true,
		showMeridian : true,
		pickerPosition : "bottom-left",
		language : 'zh-CN',//中文，需要引用zh-CN.js包
		startView : 2,//月视图
		minView : 2
	//日期时间选择器所能够提供的最精确的时间选择视图
	});
	$('#datetimepicker2').datetimepicker({
		format : 'yyyy-mm-dd',
		autoclose : true,
		todayBtn : true,
		todayHighlight : true,
		showMeridian : true,
		pickerPosition : "bottom-left",
		language : 'zh-CN',//中文，需要引用zh-CN.js包
		startView : 2,//月视图
		minView : 2
	//日期时间选择器所能够提供的最精确的时间选择视图
	});
</script>
</html>
